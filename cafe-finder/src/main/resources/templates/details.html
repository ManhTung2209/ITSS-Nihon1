<!DOCTYPE html>
<html lang="ja"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>カフェ詳細 - コーヒーファインダー</title>

    <!-- ICON -->
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/styles.css}">
</head>

<body style="
    font-family:'Noto Sans JP', sans-serif;
    background:#f2f2f2;
    margin:0;
    padding:0;
">
<nav class="navbar">
    <div class="container">
        <div class="nav-brand">
            <a th:href="@{/}">☕ コーヒーファインダー</a>
        </div>

        <ul class="nav-menu">
            <li><a th:href="@{/}">ホーム</a></li>
            <li><a th:href="@{/map}">地図</a></li>    

            <li sec:authorize="hasRole('ADMIN')">
                <a th:href="@{/admin}"
                   style="color:#d35400; font-weight:bold;">
                    🔧 管理 (Admin)
                </a>
            </li>

            <li sec:authorize="!isAuthenticated()">
                <a th:href="@{/login}">ログイン</a> 
            </li>

            <li class="dropdown" sec:authorize="isAuthenticated()">
                <a href="#" class="dropdown-toggle">
                    <span sec:authentication="name">User</span> ▾
                </a>
                <ul class="dropdown-menu">
                    <li><a th:href="@{/update}">👤 アカウント</a></li> 
                    <li>
                        <form th:action="@{/logout}" method="post" id="logoutForm">
                            <a href="#"
                               onclick="document.getElementById('logoutForm').submit(); return false;">
                                🚪 ログアウト
                            </a>
                        </form>
                    </li>
                </ul>
            </li>
        </ul>
    </div>
</nav>


<div style="
    max-width:1100px;
    background:white;
    margin:40px auto;
    padding:40px;
    border-radius:14px;
    box-shadow:0 4px 16px rgba(0,0,0,0.08);
">

    <!-- CAFE NAME -->
    <h2 th:text="${cafe.name}"
        style="margin:0 0 28px; font-size:32px; font-weight:600;">
        カフェ名
    </h2>

    <!-- CAFE INFO -->
    <div style="display:flex; gap:32px; align-items:flex-start;">

        <!-- CAFE IMAGE -->
        <img
            th:src="${cafe.image != null ? '/images/' + cafe.image : '/images/placeholder.png'}"
            th:alt="${cafe.name}"
            onerror="this.onerror=null; this.src='/images/placeholder.png';"
            style="
                width:260px;
                height:260px;
                object-fit:cover;
                border-radius:12px;
                box-shadow:0 2px 6px rgba(0,0,0,0.15);
            "
        />

        <!-- CAFE TEXT -->
        <div style="font-size:17px; line-height:1.6;">
            <p>
                <i class="fas fa-map-marker-alt" style="color:#c0392b; margin-right:8px;"></i>
                <span th:text="${cafe.address}">住所</span>
            </p>

            <p>
                <i class="fas fa-star" style="color:#f1c40f; margin-right:8px;"></i>
                <span th:text="${cafe.rating}">0</span> / 5
            </p>

            <p>
                <i class="fas fa-location-arrow" style="color:#3498db; margin-right:8px;"></i>
                <span th:text="${cafe.lat}"></span>,
                <span th:text="${cafe.lng}"></span>
            </p>

            <p>
                ステータス:
                <span th:text="${cafe.status == 'opening'
                        ? '営業中'
                        : (cafe.status == 'closed' ? '閉店' : '不明')}">
                </span>
            </p>

            <p th:text="${cafe.description}" style="margin-top:14px;"></p>
        </div>
    </div>

    <hr style="margin:32px 0;">

    <!-- MENU -->
    <h3 style="font-size:26px; margin-bottom:20px;">メニュー</h3>

    <div style="display:grid; grid-template-columns:repeat(3,1fr); gap:28px;">

        <div th:each="dish : ${dishes}"
             style="
                background:white;
                padding:18px;
                border-radius:14px;
                box-shadow:0 2px 8px rgba(0,0,0,0.08);
                display:flex;
                gap:16px;
             ">

            <img
                th:src="${dish.image != null ? '/images/' + dish.image : '/images/placeholder.png'}"
                onerror="this.onerror=null; this.src='/images/placeholder.png';"
                style="width:85px; height:85px; border-radius:12px; object-fit:cover;"
            />

            <div>
                <strong th:text="${dish.name}"></strong>
                <div><span th:text="${dish.price}"></span>円</div>
                <p th:text="${dish.description}" style="color:#666;"></p>
            </div>
        </div>

        <p th:if="${#lists.isEmpty(dishes)}"
           style="grid-column:1 / span 3; text-align:center; color:gray;">
            メニュー情報がありません。
        </p>
    </div>

    <hr style="margin:40px 0;">

    <!-- REVIEWS -->
    <h3 style="font-size:26px;">レビュー</h3>

    <div th:each="review : ${reviews}"
         style="background:#fafafa; padding:20px; border-radius:12px; margin-top:20px;">
        <strong th:text="${review.userName}"></strong>
        ★ <span th:text="${review.star}"></span> / 5
        <p th:text="${review.content}"></p>
    </div>

    <p th:if="${#lists.isEmpty(reviews)}"
       style="text-align:center; color:gray;">
        レビューはまだありません。
    </p>
    <!-- CREATE REVIEW -->
        <h3 style="font-size:24px; margin-bottom:16px;">レビューを書く</h3>

        <div sec:authorize="!isAuthenticated()"
            style="
                background:#fff3cd;
                padding:16px;
                border-radius:8px;
                color:#856404;
                margin-bottom:20px;
                border:1px solid #ffeaa7;
            ">
            <i class="fas fa-info-circle" style="margin-right:8px;"></i>
            レビューを書くにはログインしてください。
            <a href="/login" style="color:#0066cc; text-decoration:underline; margin-left:8px;">ログインページへ</a>
        </div>

        <form sec:authorize="isAuthenticated()" th:action="@{/cafes/{id}/reviews(id=${cafe.id})}" method="post"
            style="
                background:white;
                padding:22px;
                border-radius:12px;
                box-shadow:0 2px 8px rgba(0,0,0,0.08);
                display:flex;
                flex-direction:column;
                gap:18px;
            ">

            <!-- USER INFO -->
            <div style="
                background:#e8f4f8;
                padding:12px;
                border-radius:8px;
                border-left:4px solid #3498db;
                margin-bottom:8px;
            ">
                <p style="margin:0; font-size:14px; color:#555;">
                    <strong>投稿者:</strong> 
                    <span sec:authentication="principal.fullName" style="color:#3498db; font-weight:bold;">User</span>
                </p>
            </div>

            <!-- RATING -->
            <div>
                <label style="font-size:15px; font-weight:bold;">評価 (1〜5)</label>
                <select name="star" required
                    style="
                        width:120px; padding:10px;
                        border-radius:6px; border:1px solid #ccc;
                        margin-top:6px; font-size:15px;
                    ">
                    <option value="">選択してください</option>
                    <option value="5">★★★★★ (5)</option>
                    <option value="4">★★★★☆ (4)</option>
                    <option value="3">★★★☆☆ (3)</option>
                    <option value="2">★★☆☆☆ (2)</option>
                    <option value="1">★☆☆☆☆ (1)</option>
                </select>
            </div>

            <!-- COMMENT -->
            <div>
                <label style="font-size:15px; font-weight:bold;">コメント</label>
                <textarea name="content" rows="4" required
                    style="
                        width:100%; padding:10px;
                        border-radius:6px; border:1px solid #ccc;
                        margin-top:6px; font-size:15px;
                        resize:vertical;
                    "></textarea>
            </div>

            <!-- SUBMIT -->
            <button type="submit"
                style="
                    width:160px;
                    padding:12px;
                    background:#3498db;
                    color:white;
                    border:none;
                    border-radius:8px;
                    font-size:16px;
                    cursor:pointer;
                    align-self:flex-end;
                "
                onmouseover="this.style.background='#2980b9'"
                onmouseout="this.style.background='#3498db'">
                投稿する
            </button>

        </form>

</div>

</body>
</html>
